<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„å® ç‰©è™«å­ ğŸ¶</title>
    <style>
        /* --- åŸºç¡€è®¾å®š --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #FFF9C4; /* æŸ æª¬é»„èƒŒæ™¯ï¼Œæ›´æ˜äº® */
            font-family: "Muli", "Rounded Mplus 1c", "å¹¼åœ†", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none; /* é˜²æ­¢åŒå‡»é€‰ä¸­æ–‡å­— */
        }

        /* --- é¡¶éƒ¨æ  --- */
        header {
            padding: 15px;
            text-align: center;
            color: #F57F17;
            font-weight: bold;
            font-size: 18px;
            z-index: 10;
        }

        /* --- æ¸¸æˆèˆå° --- */
        #stage {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            /* åœ°æ¿æ•ˆæœ */
            background: radial-gradient(ellipse at center bottom, #FFFDE7 0%, transparent 70%); 
        }

        /* --- ç‹—ç‹—æœ¬ä½“ --- */
        .dog-wrapper {
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        /* ç‹—ç‹—å›¾ç‰‡å®¹å™¨ */
        .dog-avatar {
            width: 220px;
            height: 220px;
            /* ä½¿ç”¨æ›´ç”ŸåŠ¨çš„æŸ¯åŸºæ’å›¾ */
            background-image: url('https://cdn-icons-png.flaticon.com/512/2395/2395796.png'); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 5;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
            animation: breathe 3s ease-in-out infinite; /* å‘¼å¸åŠ¨ç”» */
        }

        /* ç‚¹å‡»æ—¶çš„æŒ‰å‹æ•ˆæœ */
        .dog-wrapper:active .dog-avatar {
            transform: scale(0.95) translateY(5px);
        }

        /* åŠ¨ç”»ï¼šå¼€å¿ƒè·³è·ƒ */
        .jump {
            animation: jump-anim 0.6s ease !important;
        }
        @keyframes jump-anim {
            0% { transform: translateY(0); }
            50% { transform: translateY(-30px) scale(1.05); }
            100% { transform: translateY(0); }
        }

        /* åŠ¨ç”»ï¼šæ€è€ƒæ‘‡æ‘† */
        .thinking {
            animation: shake-anim 0.5s ease-in-out infinite !important;
        }
        @keyframes shake-anim {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        /* å‘¼å¸åŠ¨ç”» */
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* --- å¯¹è¯æ°”æ³¡ --- */
        #speech-bubble {
            position: absolute;
            top: -140px; /* åœ¨ç‹—ç‹—å¤´é¡¶ä¸Šæ–¹ */
            left: 50%;
            transform: translateX(-50%) scale(0); /* é»˜è®¤éšè— */
            background: white;
            padding: 15px 20px;
            border-radius: 20px;
            border: 3px solid #FBC02D;
            color: #5D4037;
            font-size: 15px;
            min-width: 150px;
            max-width: 260px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            z-index: 10;
        }
        
        #speech-bubble.show {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }

        /* æ°”æ³¡å°–è§’ */
        #speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            margin-left: -10px;
            border-width: 15px 10px 0;
            border-style: solid;
            border-color: #FBC02D transparent transparent;
        }

        /* --- é£˜è½çš„çˆ±å¿ƒç‰¹æ•ˆ --- */
        .heart {
            position: absolute;
            color: #FF5252;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 20;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* --- åº•éƒ¨æ§åˆ¶åŒº --- */
        .controls {
            background: white;
            padding: 15px 15px 30px 15px; /* åº•éƒ¨å¤šç•™ç‚¹ç™½é€‚é…æ‰‹æœº */
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* å¿«æ·åŠ¨ä½œæŒ‰é’®æ  */
        .action-bar {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            background-color: #FFF3E0;
            border: 2px solid #FFE0B2;
            color: #E65100;
            padding: 10px 0;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .action-btn:active {
            transform: scale(0.95);
            background-color: #FFE0B2;
        }
        .action-btn span { font-size: 18px; }

        /* è¾“å…¥æ¡†åŒºåŸŸ */
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
        }
        input:focus { border-color: #FBC02D; }

        .send-btn {
            background: #FBC02D;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    </style>
</head>
<body>

    <header>âœ¨ è™«å­çš„ç‹—çª âœ¨</header>

    <div id="stage">
        <div class="dog-wrapper" id="dog-wrapper" onclick="petDog()">
            <div id="speech-bubble">æ±ªï¼å¿«é™ªæˆ‘ç©ï¼ğŸ¾</div>
            <div class="dog-avatar" id="dog"></div>
        </div>
    </div>

    <div class="controls">
        <div class="action-bar">
            <button class="action-btn" onclick="triggerAction('å–‚è‚‰è‚‰', 'ğŸ–')">
                <span>ğŸ–</span> å–‚é£Ÿ
            </button>
            <button class="action-btn" onclick="triggerAction('æ‰”é£ç›˜', 'ğŸ¥')">
                <span>ğŸ¥</span> ç©çƒ
            </button>
            <button class="action-btn" onclick="triggerAction('æ‘¸æ‘¸å¤´', 'ğŸ‘‹')">
                <span>ğŸ‘‹</span> æ‘¸æ‘¸
            </button>
        </div>

        <div class="input-group">
            <input type="text" id="user-input" placeholder="å’Œè™«å­èŠå¤©..." autocomplete="off">
            <button class="send-btn" id="send-btn" onclick="sendCustomMessage()">â¤</button>
        </div>
    </div>

    <script>
        const dogWrapper = document.getElementById('dog-wrapper');
        const dogAvatar = document.getElementById('dog');
        const bubble = document.getElementById('speech-bubble');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const actionBtns = document.querySelectorAll('.action-btn');

        let isThinking = false;

        // 1. åˆå§‹åŒ–æ˜¾ç¤º
        setTimeout(() => {
            showBubble("æˆ‘æ˜¯è™«å­ï¼ç‚¹å‡»æˆ‘èº«ä½“å¯ä»¥æ‘¸æˆ‘å“¦~ ğŸ¶");
        }, 800);

        // 2. æ‘¸ç‹—ç‹—çš„æ•ˆæœ (çº¯å‰ç«¯ç‰¹æ•ˆ)
        function petDog() {
            if (isThinking) return;
            
            // ç‹—ç‹—è·³ä¸€ä¸‹
            dogAvatar.classList.remove('jump');
            void dogAvatar.offsetWidth; // è§¦å‘é‡ç»˜
            dogAvatar.classList.add('jump');

            // çˆ†å‡ºçˆ±å¿ƒ
            createHeart();
            createHeart();
            createHeart();

            // å¦‚æœæ°”æ³¡æ˜¯ç©ºçš„æˆ–è€…æ¶ˆå¤±äº†ï¼Œæ˜¾ç¤ºä¸€å¥æ’’å¨‡
            if (!bubble.classList.contains('show')) {
                showBubble("å˜¿å˜¿ï¼Œå¥½èˆ’æœ~ â¤ï¸");
            }
        }

        // 3. è§¦å‘å¿«æ·åŠ¨ä½œ (å‘é€ç‰¹å®šæŒ‡ä»¤ç»™AI)
        function triggerAction(actionName, emoji) {
            if (isThinking) return;
            // æ¨¡æ‹Ÿç”¨æˆ·å‘äº†â€œæˆ‘ç»™ä½ å–‚è‚‰è‚‰â€è¿™æ ·çš„æŒ‡ä»¤
            handleNetworkRequest(`ä¸»äººå¯¹æˆ‘åšäº†åŠ¨ä½œï¼š${actionName}ã€‚è¯·æ ¹æ®è¿™ä¸ªåŠ¨ä½œåšå‡ºååº”ã€‚`);
            
            // ç•Œé¢ä¸Šç«‹åˆ»ç»™ç‚¹åé¦ˆ
            showBubble(`${emoji} æ”¶åˆ°ï¼ç­‰å¾…è™«å­ååº”...`);
        }

        // 4. å‘é€è‡ªå®šä¹‰æ–‡å­—
        function sendCustomMessage() {
            const text = userInput.value.trim();
            if (!text || isThinking) return;
            
            handleNetworkRequest(text);
            userInput.value = '';
        }

        // 5. æ ¸å¿ƒç½‘ç»œè¯·æ±‚å‡½æ•°
        async function handleNetworkRequest(messageText) {
            setLoading(true);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText })
                });

                const data = await response.json();
                
                if (data.reply) {
                    showBubble(data.reply);
                    // æ”¶åˆ°å›å¤æ—¶ï¼Œç‹—ç‹—å¼€å¿ƒè·³ä¸€ä¸‹
                    dogAvatar.classList.remove('jump');
                    void dogAvatar.offsetWidth;
                    dogAvatar.classList.add('jump');
                } else {
                    showBubble("æ±ªï¼Ÿåˆšæ‰èµ°ç¥äº†...");
                }

            } catch (error) {
                showBubble("å—·å‘œ... ç½‘ç»œæ–­å¼€äº† ğŸ˜¿");
            } finally {
                setLoading(false);
            }
        }

        // --- è¾…åŠ©ç‰¹æ•ˆå‡½æ•° ---

        function showBubble(text) {
            bubble.textContent = text;
            bubble.classList.add('show');
            
            // 5ç§’åè‡ªåŠ¨éšè—æ°”æ³¡ï¼Œé˜²æ­¢ä¸€ç›´æŒ¡ç€
            // clearTimeout(window.bubbleTimer);
            // window.bubbleTimer = setTimeout(() => {
            //     bubble.classList.remove('show');
            // }, 8000);
        }

        function setLoading(loading) {
            isThinking = loading;
            sendBtn.disabled = loading;
            actionBtns.forEach(btn => btn.disabled = loading);

            if (loading) {
                dogAvatar.classList.add('thinking'); // å¼€å§‹æ‘‡æ‘†æ€è€ƒ
                bubble.textContent = "ğŸ¤” æ€è€ƒä¸­...";
                bubble.classList.add('show');
            } else {
                dogAvatar.classList.remove('thinking'); // åœæ­¢æ‘‡æ‘†
            }
        }

        // åˆ›å»ºé£˜è½çš„å°çˆ±å¿ƒ
        function createHeart() {
            const heart = document.createElement('div');
            heart.classList.add('heart');
            heart.textContent = 'â¤ï¸';
            
            // éšæœºä½ç½®
            const rect = dogWrapper.getBoundingClientRect();
            const randomX = (Math.random() - 0.5) * 100;
            
            heart.style.left = (rect.width / 2 + randomX) + 'px';
            heart.style.top = (rect.height / 2) + 'px';
            
            dogWrapper.appendChild(heart);

            // åŠ¨ç”»ç»“æŸååˆ é™¤å…ƒç´ 
            setTimeout(() => {
                heart.remove();
            }, 1000);
        }

        // å›è½¦å‘é€
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendCustomMessage();
        });

    </script>
</body>
</html>