<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è™«å­çš„ç‹—çª ğŸ¶</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #FFFDE7; /* æ›´æ¸©æš–çš„å¥¶æ²¹è‰²èƒŒæ™¯ */
            font-family: "Muli", "Rounded Mplus 1c", "å¹¼åœ†", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ»šåŠ¨ */
        }

        /* --- é¡¶éƒ¨æ ‡é¢˜æ  --- */
        header {
            background-color: #FFAB40;
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        /* --- ä¸»èˆå°åŒºåŸŸ (æ ¸å¿ƒäº¤äº’åŒº) --- */
        #stage {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* å†…å®¹é ä¸‹å¯¹é½ */
            align-items: center;
            padding-bottom: 20px;
            background-image: radial-gradient(circle at center bottom, #fff3e0 0%, #fffde7 70%); /* åŠ ä¸ªç®€å•çš„èƒŒæ™¯å…‰æ™• */
        }

        /* ç”¨æˆ·å†å²æ¶ˆæ¯ (æ·¡å‡ºæ˜¾ç¤º) */
        #user-history-area {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding: 0 20px;
            gap: 10px;
            max-height: 30%;
            overflow: hidden;
            pointer-events: none; /* ä¸é˜»æŒ¡ç‚¹å‡» */
        }

        .user-bubble-fade {
            background-color: rgba(255, 152, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 13px;
            max-width: 70%;
            opacity: 0.6;
            transform: scale(0.9);
            transition: all 0.5s ease;
        }

        /* --- ç‹—ç‹—å½¢è±¡å®¹å™¨ --- */
        .dog-container {
            position: relative;
            width: 180px;
            height: 180px;
            /* è¿™é‡Œæ”¾ç‹—ç‹—çš„å›¾ç‰‡ï¼Œæˆ‘ç”¨äº†ä¸€ä¸ªåœ¨çº¿çš„å¯çˆ±å›¾æ ‡ä»£æ›¿ */
            /* ä½ å¯ä»¥å°†ä½ çš„å›¾ç‰‡æ”¾å…¥ public æ–‡ä»¶å¤¹ï¼Œç„¶åä¿®æ”¹ url('ä½ çš„å›¾ç‰‡å.png') */
            background-image: url('https://cdn-icons-png.flaticon.com/512/616/616554.png'); 
            background-size: cover;
            background-position: center;
            z-index: 5;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            animation: breath 3s ease-in-out infinite; /* ç®€å•çš„å‘¼å¸åŠ¨æ•ˆ */
        }

        @keyframes breath {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        /* --- ç‹—ç‹—çš„å¤§å¯¹è¯æ°”æ³¡ --- */
        #dog-speech-bubble {
            position: absolute;
            bottom: 190px; /* åœ¨ç‹—ç‹—å¤´é¡¶ */
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            color: #5D4037;
            padding: 20px 25px;
            border-radius: 30px;
            font-size: 16px;
            line-height: 1.6;
            max-width: 80%;
            width: max-content;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 6;
            border: 3px solid #FFAB40;
            /* åˆå§‹çŠ¶æ€ä¸å¯è§ï¼Œé€šè¿‡ JS æ·»åŠ  .show ç±»æ¥æ˜¾ç¤º */
            opacity: 0; 
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* å¼¹æ€§åŠ¨ç”» */
            transform-origin: bottom center;
        }

        /* æ°”æ³¡æ˜¾ç¤ºæ—¶çš„çŠ¶æ€ */
        #dog-speech-bubble.show {
            opacity: 1;
            bottom: 200px; /* ç¨å¾®ä¸Šæµ® */
        }

        /* æ°”æ³¡çš„å°å°¾å·´ (æŒ‡å‘ç‹—ç‹—) */
        #dog-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 15px 15px 0;
            border-style: solid;
            border-color: white transparent transparent;
            z-index: 1;
        }
        #dog-speech-bubble::before {
             content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 18px 18px 0;
            border-style: solid;
            border-color: #FFAB40 transparent transparent;
            z-index: 0;
        }


        /* --- åº•éƒ¨è¾“å…¥åŒºåŸŸ --- */
        .input-area {
            background: white;
            padding: 15px;
            border-top: 2px solid #FFF3E0;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }

        input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #FFCC80;
            border-radius: 30px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus {
            border-color: #FF9800;
        }

        button {
            background-color: #FF9800;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);
        }
        button:active {
            transform: scale(0.9);
        }
        button:disabled {
            background-color: #FFCC80;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <header>
        è™«å­çš„ç‹—çª ğŸ¦´
    </header>

    <div id="stage">
        <div id="user-history-area"></div>

        <div id="dog-speech-bubble" class="show">
            æ±ªï¼æˆ‘æ˜¯è™«å­ï¼å¿«æ‹¿å¥½åƒçš„æ¥ï¼ğŸ–
        </div>
        
        <div class="dog-container"></div>
    </div>


    <div class="input-area">
        <input type="text" id="user-input" placeholder="å’Œè™«å­è¯´ç‚¹ä»€ä¹ˆ..." autocomplete="off" />
        <button id="send-btn">ğŸ¾</button>
    </div>

    <script>
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const dogSpeechBubble = document.getElementById('dog-speech-bubble');
        const userHistoryArea = document.getElementById('user-history-area');

        // å‘é€æ¶ˆæ¯çš„ä¸»å‡½æ•°
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ (æ·¡å‡ºæ•ˆæœ)
            showUserBubble(text);
            userInput.value = '';
            userInput.focus();

            // 2. æ”¹å˜çŠ¶æ€ï¼šè™«å­æ€è€ƒä¸­
            setDogState('thinking');

            try {
                // 3. è¯·æ±‚åç«¯ API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                const data = await response.json();

                // 4. æ˜¾ç¤ºè™«å­çš„å›å¤
                if (data.reply) {
                    setDogSpeaking(data.reply);
                } else {
                    setDogSpeaking("æ±ªï¼Ÿæˆ‘æ²¡å¬æ¸…... (æ¥å£è¿”å›é”™è¯¯)");
                }

            } catch (error) {
                console.error("Error:", error);
                setDogSpeaking("å—·å‘œ... ç½‘ç»œå¥½åƒæ–­äº†ï¼Œè”ç³»ä¸ä¸Šä¸»äººäº† ğŸ˜¿");
            } finally {
                sendBtn.disabled = false;
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®ç‹—ç‹—è¯´è¯å†…å®¹å¹¶è§¦å‘åŠ¨ç”»
        function setDogSpeaking(text) {
            // å…ˆéšè—ï¼Œå†ä¿®æ”¹æ–‡å­—ï¼Œå†æ˜¾ç¤ºï¼Œè§¦å‘åŠ¨ç”»
            dogSpeechBubble.classList.remove('show');
            
            setTimeout(() => {
                dogSpeechBubble.textContent = text;
                dogSpeechBubble.classList.add('show');
            }, 300); // ç­‰å¾…éšè—åŠ¨ç”»å®Œæˆ
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®æ€è€ƒçŠ¶æ€
        function setDogState(state) {
            sendBtn.disabled = true;
            if (state === 'thinking') {
                setDogSpeaking("ğŸ¤” è™«å­æ­£åœ¨åŠªåŠ›æ€è€ƒ...");
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºç”¨æˆ·å†å²å°æ°”æ³¡
        function showUserBubble(text) {
            const bubble = document.createElement('div');
            bubble.className = 'user-bubble-fade';
            bubble.textContent = text;
            userHistoryArea.appendChild(bubble);

            // è¶…è¿‡3æ¡å°±åˆ é™¤æœ€æ—§çš„ï¼Œä¿æŒç•Œé¢æ•´æ´
            while (userHistoryArea.children.length > 3) {
                userHistoryArea.removeChild(userHistoryArea.firstChild);
            }
        }

        // ç»‘å®šäº‹ä»¶
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // åˆå§‹åŠ¨ç”»
        setTimeout(() => {
             dogSpeechBubble.classList.add('show');
        }, 500);

    </script>
</body>
</html>