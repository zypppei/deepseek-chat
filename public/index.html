<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„å® ç‰©è™«å­ ğŸ¶</title>
    <style>
        /* --- åŸºç¡€è®¾å®š --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #FFF9C4;
            font-family: "Muli", "Rounded Mplus 1c", "å¹¼åœ†", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- å…¨å±å¼ºåé¦ˆé®ç½© --- */
        .fullscreen-feedback {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 32px;
            opacity: 0;
            pointer-events: none; /* é»˜è®¤ä¸é˜»æŒ¡é¼ æ ‡ */
            transition: opacity 0.3s ease;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .fullscreen-feedback.show {
            opacity: 1;
            pointer-events: auto; /* æ˜¾ç¤ºæ—¶é˜»æŒ¡æ“ä½œ */
        }
        .fullscreen-feedback .emoji { font-size: 80px; margin-bottom: 20px; }

        /* æˆåŠŸ-ç»¿è‰² */
        #overlay-success { background: rgba(76, 175, 80, 0.85); }
        /* å¤±è´¥-çº¢è‰² */
        #overlay-fail { background: rgba(244, 67, 54, 0.85); }


        header {
            padding: 15px;
            text-align: center;
            color: #F57F17;
            font-weight: bold;
            font-size: 18px;
            z-index: 10;
        }

        /* --- æ¸¸æˆèˆå° --- */
        #stage {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: radial-gradient(ellipse at center bottom, #FFFDE7 0%, transparent 70%);
            overflow: hidden; /* é˜²æ­¢è¤ç«è™«é£å‡ºå» */
        }

        /* --- è¤ç«è™« --- */
        #firefly {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #FFEB3B;
            border-radius: 50%;
            box-shadow: 0 0 10px #FFEB3B, 0 0 20px #FBC02D;
            top: 30%;
            left: 50%;
            opacity: 0; /* é»˜è®¤éšè— */
            z-index: 4;
            transition: opacity 0.3s;
        }
        /* è¤ç«è™«é£èˆåŠ¨ç”» */
        #firefly.flying {
            opacity: 1;
            animation: fly-anim 2s infinite alternate ease-in-out;
        }
        @keyframes fly-anim {
            0% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-50px, -30px) scale(1.1); }
            50% { transform: translate(40px, 20px) scale(0.9); }
            75% { transform: translate(-30px, 40px) scale(1.2); }
            100% { transform: translate(20px, -20px) scale(1); }
        }


        /* --- ç‹—ç‹—æœ¬ä½“ --- */
        .dog-wrapper {
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
        }
        /* ç‹—ç‹—è¿½é€åŠ¨ç”» */
        .dog-wrapper.chasing {
            animation: chase-anim 0.8s infinite alternate ease-in-out;
        }
        @keyframes chase-anim {
            0% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-30px) rotate(-5deg); }
            75% { transform: translateX(30px) rotate(5deg); }
            100% { transform: translateX(0) rotate(0deg); }
        }
        
        .dog-avatar {
            width: 220px;
            height: 220px;
            /* æ¢æˆäº†æ›´æ¸…æ™°çš„æŸ´çŠ¬å›¾ç‰‡ */
            background-image: url('https://cdn-icons-png.flaticon.com/512/1864/1864514.png'); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 5;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
            animation: breathe 3s ease-in-out infinite;
        }

        .dog-wrapper:active .dog-avatar {
            transform: scale(0.95) translateY(5px);
        }

        .jump { animation: jump-anim 0.6s ease !important; }
        @keyframes jump-anim {
            0% { transform: translateY(0); }
            50% { transform: translateY(-30px) scale(1.05); }
            100% { transform: translateY(0); }
        }

        .thinking { animation: shake-anim 0.5s ease-in-out infinite !important; }
        @keyframes shake-anim {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* --- å¯¹è¯æ°”æ³¡ --- */
        #speech-bubble {
            position: absolute;
            top: -140px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: white;
            padding: 15px 20px;
            border-radius: 20px;
            border: 3px solid #FBC02D;
            color: #5D4037;
            font-size: 15px;
            min-width: 150px;
            max-width: 260px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            z-index: 10;
        }
        #speech-bubble.show {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }
        #speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            margin-left: -10px;
            border-width: 15px 10px 0;
            border-style: solid;
            border-color: #FBC02D transparent transparent;
        }

        .heart {
            position: absolute;
            color: #FF5252;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 20;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* --- åº•éƒ¨æ§åˆ¶åŒº --- */
        .controls {
            background: white;
            padding: 15px 15px 30px 15px;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative; /* ä¸ºäº†loadingé®ç½©å®šä½ */
        }

        /* æ§åˆ¶åŒºé”å®šé®ç½© */
        #controls-lock {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.6);
            z-index: 20;
            border-radius: 30px 30px 0 0;
            display: none; /* é»˜è®¤éšè— */
        }
        #controls-lock.locked { display: block; }

        .action-bar {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            background-color: #FFF3E0;
            border: 2px solid #FFE0B2;
            color: #E65100;
            padding: 10px 0;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .action-btn:active {
            transform: scale(0.95);
            background-color: #FFE0B2;
        }
        .action-btn span { font-size: 22px; }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
        }
        input:focus { border-color: #FBC02D; }

        .send-btn {
            background: #FBC02D;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    </style>
</head>
<body>

    <div id="overlay-success" class="fullscreen-feedback">
        <div class="emoji">ğŸ‰âœ¨</div>
        <div>æŠ“åˆ°è¤ç«è™«å•¦ï¼</div>
    </div>
    <div id="overlay-fail" class="fullscreen-feedback">
        <div class="emoji">ğŸ’¨ğŸƒ</div>
        <div>å“å‘€ï¼Œé£èµ°äº†...</div>
    </div>

    <header>âœ¨ è™«å­çš„ç‹—çª âœ¨</header>

    <div id="stage">
        <div id="firefly"></div> <div class="dog-wrapper" id="dog-wrapper" onclick="petDog()">
            <div id="speech-bubble">æ±ªï¼æˆ‘æ˜¯è™«å­ï¼<br>ç‚¹æˆ‘èº«ä½“å¯ä»¥æ‘¸æ‘¸å“¦~ ğŸ¶</div>
            <div class="dog-avatar" id="dog"></div>
        </div>
    </div>

    <div class="controls">
        <div id="controls-lock"></div> <div class="action-bar">
            <button class="action-btn" onclick="triggerAction('å–‚è‚‰è‚‰', 'ğŸ–')">
                <span>ğŸ–</span>å–‚é£Ÿ
            </button>
            <button class="action-btn" onclick="triggerAction('æ‰”é£ç›˜', 'ğŸ¥')">
                <span>ğŸ¥</span>ç©çƒ
            </button>
            <button class="action-btn" onclick="startCatchingFirefly()">
                <span>ğŸ¦Ÿ</span>æŠ“è™«
            </button>
        </div>

        <div class="input-group">
            <input type="text" id="user-input" placeholder="å’Œè™«å­èŠå¤©..." autocomplete="off">
            <button class="send-btn" id="send-btn" onclick="sendCustomMessage()">â¤</button>
        </div>
    </div>

    <script>
        const dogWrapper = document.getElementById('dog-wrapper');
        const dogAvatar = document.getElementById('dog');
        const bubble = document.getElementById('speech-bubble');
        const userInput = document.getElementById('user-input');
        const controlsLock = document.getElementById('controls-lock');
        const firefly = document.getElementById('firefly');
        const overlaySuccess = document.getElementById('overlay-success');
        const overlayFail = document.getElementById('overlay-fail');

        let isBusy = false;

        // åˆå§‹åŒ–
        setTimeout(() => { bubble.classList.add('show'); }, 800);

        // --- æ ¸å¿ƒæ–°åŠŸèƒ½ï¼šæŠ“è¤ç«è™« ---
        function startCatchingFirefly() {
            if (isBusy) return;
            setBusy(true); // é”å®šæ“ä½œ

            // 1. å¼€å§‹åŠ¨ç”»
            showBubble("æ±ªï¼æœ‰è™«å­ï¼åˆ«è·‘ï¼ğŸ¦Ÿ");
            firefly.classList.add('flying'); // æ˜¾ç¤ºè¤ç«è™«
            dogWrapper.classList.add('chasing'); // ç‹—ç‹—å¼€å§‹è¿½

            // 2. è¿½é€ä¸€æ®µæ—¶é—´åå‡ºç»“æœ (æ¯”å¦‚ 2ç§’)
            setTimeout(() => {
                // è®¡ç®—æ¦‚ç‡ï¼š30% æˆåŠŸ
                const isCaught = Math.random() < 0.3;

                // åœæ­¢åŠ¨ç”»
                firefly.classList.remove('flying');
                dogWrapper.classList.remove('chasing');
                bubble.classList.remove('show'); // éšè—æ°”æ³¡

                // 3. æ˜¾ç¤ºå…¨å±å¼ºåé¦ˆ
                if (isCaught) {
                    overlaySuccess.classList.add('show');
                    // (å¯é€‰) å¯ä»¥åœ¨è¿™é‡Œæ‚„æ‚„å‘ä¸ªè¯·æ±‚å‘Šè¯‰AIæŠ“åˆ°äº†
                } else {
                    overlayFail.classList.add('show');
                    // (å¯é€‰) å¯ä»¥åœ¨è¿™é‡Œæ‚„æ‚„å‘ä¸ªè¯·æ±‚å‘Šè¯‰AIæ²¡æŠ“åˆ°
                }

                // 4. åé¦ˆæ˜¾ç¤ºä¸€æ®µæ—¶é—´åæ¢å¤çŠ¶æ€ (æ¯”å¦‚ 2ç§’)
                setTimeout(() => {
                    overlaySuccess.classList.remove('show');
                    overlayFail.classList.remove('show');
                    
                    // æ¢å¤æ°”æ³¡å¹¶è§£é™¤é”å®š
                    if (isCaught) {
                        showBubble("å˜¿å˜¿ï¼ŒæŠ“åˆ°å•¦ï¼å‰ä¸å‰å®³ï¼âœ¨");
                        dogJump();
                    } else {
                        showBubble("å—·å‘œ... å¥½ç´¯ï¼Œä¸‹æ¬¡ä¸€å®šæŠ“ä½...");
                    }
                    setBusy(false); // è§£é”æ“ä½œ

                }, 2000);

            }, 2000); // è¿½é€æ—¶é•¿
        }


        // --- åŸæœ‰åŠŸèƒ½ ---

        function petDog() {
            if (isBusy) return;
            dogJump();
            createHeart(); createHeart(); createHeart();
            if (!bubble.classList.contains('show')) showBubble("å˜¿å˜¿ï¼Œå¥½èˆ’æœ~ â¤ï¸");
        }

        function triggerAction(actionName, emoji) {
            if (isBusy) return;
            handleNetworkRequest(`ä¸»äººå¯¹æˆ‘åšäº†åŠ¨ä½œï¼š${actionName}ã€‚è¯·æ ¹æ®è¿™ä¸ªåŠ¨ä½œåšå‡ºååº”ã€‚`);
            showBubble(`${emoji} æ”¶åˆ°ï¼ç­‰å¾…è™«å­ååº”...`);
        }

        function sendCustomMessage() {
            const text = userInput.value.trim();
            if (!text || isBusy) return;
            handleNetworkRequest(text);
            userInput.value = '';
        }

        async function handleNetworkRequest(messageText) {
            setBusy(true);
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText })
                });
                const data = await response.json();
                if (data.reply) {
                    showBubble(data.reply);
                    dogJump();
                } else {
                    showBubble("æ±ªï¼Ÿåˆšæ‰èµ°ç¥äº†...");
                }
            } catch (error) {
                showBubble("å—·å‘œ... ç½‘ç»œæ–­å¼€äº† ğŸ˜¿");
            } finally {
                setBusy(false);
            }
        }

        // --- è¾…åŠ©å‡½æ•° ---

        function showBubble(text) {
            bubble.innerHTML = text; // ä½¿ç”¨innerHTMLæ”¯æŒæ¢è¡Œ
            bubble.classList.add('show');
        }

        function dogJump() {
            dogAvatar.classList.remove('jump');
            void dogAvatar.offsetWidth;
            dogAvatar.classList.add('jump');
        }

        // è®¾ç½®å¿™ç¢ŒçŠ¶æ€ï¼ˆé”å®šæ‰€æœ‰æ“ä½œï¼‰
        function setBusy(busy) {
            isBusy = busy;
            if (busy) {
                controlsLock.classList.add('locked');
                if (bubble.textContent.includes("æ€è€ƒä¸­")) {
                   dogAvatar.classList.add('thinking');
                }
            } else {
                controlsLock.classList.remove('locked');
                dogAvatar.classList.remove('thinking');
            }
        }

        function createHeart() {
            const heart = document.createElement('div');
            heart.classList.add('heart'); heart.textContent = 'â¤ï¸';
            const rect = dogWrapper.getBoundingClientRect();
            heart.style.left = (rect.width / 2 + (Math.random() - 0.5) * 100) + 'px';
            heart.style.top = (rect.height / 2) + 'px';
            dogWrapper.appendChild(heart);
            setTimeout(() => heart.remove(), 1000);
        }

        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendCustomMessage(); });

    </script>
</body>
</html>