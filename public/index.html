<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 助手 (修复版)</title>
    <!-- 引入 marked 库用于美化输出 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; height: 100vh; margin: 0; }
        .chat-container { width: 100%; max-width: 800px; background: white; display: flex; flex-direction: column; height: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { padding: 15px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 10px 15px; border-radius: 10px; max-width: 80%; line-height: 1.5; }
        .user { background: #007bff; color: white; align-self: flex-end; }
        .ai { background: #f1f0f0; color: black; align-self: flex-start; }
        .input-area { padding: 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #ccc; }
        /* 代码块样式 */
        pre { background: #222; color: #fff; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">Gemini 2.0 修复版</div>
    <div id="messages">
        <div class="message ai">也就是现在，试试看发消息给我？</div>
    </div>
    <div class="input-area">
        <input type="text" id="userInput" placeholder="输入消息..." />
        <!-- 注意：onclick 这里必须完全匹配下面的函数名 -->
        <button id="sendBtn" onclick="sendMessage()">发送</button>
    </div>
</div>

<script>
    // --- 调试代码：检查 JS 是否成功加载 ---
    console.log("JS 脚本已启动！如果没有看到这句话，说明代码有严重错误。");

    const messagesDiv = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    // 核心函数：sendMessage
    async function sendMessage() {
        console.log("点击了发送按钮");
        
        const text = userInput.value.trim();
        if (!text) {
            alert("请输入内容！");
            return;
        }

        // 1. 显示用户消息
        addMessage(text, 'user');
        
        // 2. 锁定界面
        userInput.value = '';
        sendBtn.disabled = true;
        sendBtn.innerText = '发送中...';

        try {
            console.log("正在请求后端...");
            // 发送请求给 Node.js 后端
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            console.log("后端响应状态:", response.status);
            const data = await response.json();

            if (data.error) {
                addMessage("错误: " + data.error, 'ai');
            } else {
                addMessage(data.reply, 'ai');
            }
        } catch (err) {
            console.error("请求失败:", err);
            addMessage("连接服务器失败，请确认终端里 'node server.js' 正在运行。", 'ai');
        } finally {
            // 3. 恢复界面
            sendBtn.disabled = false;
            sendBtn.innerText = '发送';
            userInput.focus();
        }
    }

    // 辅助函数：在屏幕上添加消息气泡
    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        
        if (sender === 'ai' && typeof marked !== 'undefined') {
            // 如果加载了 marked 库，就用它渲染 Markdown
            div.innerHTML = marked.parse(text);
        } else {
            // 否则直接显示文本
            div.textContent = text;
        }
        
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // 回车键发送功能
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });
</script>

</body>
</html>